<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<!-- quicksecureclient.qdoc -->
  <meta name="description" content="Securing the CoAP client and using it with a Qt Quick user interface.">
  <title>Quick Secure CoAP Client | Qt CoAP 6.6.0</title>
  <link rel="stylesheet" type="text/css" href="style/offline-simple.css" />
  <script type="text/javascript">
    document.getElementsByTagName("link").item(0).setAttribute("href", "style/offline.css");
    // loading style sheet breaks anchors that were jumped to before
    // so force jumping to anchor again
    setTimeout(function() {
        var anchor = location.hash;
        // need to jump to different anchor first (e.g. none)
        location.hash = "#";
        setTimeout(function() {
            location.hash = anchor;
        }, 0);
    }, 0);
  </script>
</head>
<body>
<div class="header" id="qtdocheader">
    <div class="main">
    <div class="main-rounded">
        <div class="navigationbar">
        <ul>
<li><a href="../qtdoc/index.html" translate="no">Qt 6.6</a></li>
<li><a href="qtcoap-index.html" translate="no">Qt CoAP</a></li>
<li><a href="qtcoap-examples.html" translate="no">Qt CoAP Examples</a></li>
<li>Quick Secure CoAP Client</li>
<li id="buildversion"><a href="qtcoap-index.html" translate="no">Qt 6.6&#x2e;0 Reference Documentation</a></li>
    </ul>
    </div>
</div>
<div class="content">
<div class="line">
<div class="content mainContent">
<div class="sidebar">
<div class="toc">
<h3 id="toc">Contents</h3>
<ul>
<li class="level1"><a href="#running-the-example">Running the Example</a></li>
<li class="level1"><a href="#exposing-c-classes-to-qml">Exposing C++ Classes to QML</a></li>
<li class="level1"><a href="#adjusting-build-files">Adjusting Build Files</a></li>
<li class="level2"><a href="#cmake">CMake</a></li>
<li class="level2"><a href="#qmake">qmake</a></li>
<li class="level1"><a href="#using-new-qml-types">Using New QML Types</a></li>
<li class="level2"><a href="#creating-the-client">Creating the Client</a></li>
<li class="level2"><a href="#sending-a-request">Sending a Request</a></li>
<li class="level1"><a href="#setting-up-a-secure-coap-server">Setting Up a Secure CoAP Server</a></li>
<li class="level2"><a href="#setting-up-a-server-for-psk-mode">Setting Up a Server For PSK Mode</a></li>
<li class="level2"><a href="#setting-up-a-server-for-certificate-mode">Setting Up a Server For Certificate Mode</a></li>
<li class="level2"><a href="#getting-the-ip-address">Getting The IP Address</a></li>
<li class="level2"><a href="#terminating-a-docker-container">Terminating a Docker Container</a></li>
</ul>
</div>
<div class="sidebar-content" id="sidebar-content"></div></div>
<h1 class="title">Quick Secure CoAP Client</h1>
<!-- $$$quicksecureclient-brief -->
<p>Securing the CoAP client and using it with a Qt Quick user interface.</p>
<!-- @@@quicksecureclient -->
<!-- $$$quicksecureclient-description -->
<div class="descr" id="details">
<p class="centerAlign"><img src="images/quicksecureclient.png" alt="" /></p><p><i>Quick Secure CoAP Client</i> demonstrates how to create a secure CoAP client and use it in a Qt Quick application.</p>
<div class="admonition note">
<p><b>Note: </b>Qt CoAP does not provide a QML API in its current version. However, you can make the C++ classes of the module available to QML as it is shown in the example.</p>
</div>
<h4 id="running-the-example">Running the Example</h4>
<p>To run the example from <a href="https://doc.qt.io/qtcreator/index.html" translate="no">Qt Creator</a>, open the <b translate="no">Welcome</b> mode and select the example from <b translate="no">Examples</b>. For more information, visit <a href="https://doc.qt.io/qtcreator/creator-build-example-application.html" translate="no">Building and Running an Example</a>.</p>
<p>To run the example application, you first need to set up a secure CoAP server. You can run the example with any secure CoAP server supporting one of the <i>pre-shared key (PSK)</i> or <i>certificate</i> authentication modes. For more information about setting up a secure CoAP server, see <a href="qtcoap-quicksecureclient-example.html#setting-up-a-secure-coap-server" translate="no">Setting Up a Secure CoAP Server</a>.</p>
<h4 id="exposing-c-classes-to-qml">Exposing C++ Classes to QML</h4>
<p>In this example, you need to expose the <a href="qcoapclient.html" translate="no">QCoapClient</a> class and the <a href="qtcoap.html" translate="no">QtCoap</a> namespace to QML. To achieve this, create a custom wrapper class and use the special <a href="../qtqml/qtqml-cppintegration-definetypes.html" translate="no">registration macros</a>.</p>
<p>Create the <code translate="no">QmlCoapSecureClient</code> class as a wrapper around <a href="qcoapclient.html" translate="no">QCoapClient</a>. This class also holds the selected security mode and security configuration parameters. Use the <a href="../qtcore/qobject.html#Q_INVOKABLE" translate="no">Q_INVOKABLE</a> macro to expose several methods to QML. Also use the <a href="../qtqml/qqmlengine.html#QML_NAMED_ELEMENT" translate="no">QML_NAMED_ELEMENT</a> macro to register the class in QML as <code translate="no">CoapSecureClient</code>.</p>
<pre class="cpp" translate="no">
 <span class="keyword">class</span> QmlCoapSecureClient : <span class="keyword">public</span> <span class="type"><a href="../qtcore/qobject.html" translate="no">QObject</a></span>
 {
     Q_OBJECT
     QML_NAMED_ELEMENT(CoapSecureClient)

 <span class="keyword">public</span>:
     QmlCoapSecureClient(<span class="type"><a href="../qtcore/qobject.html" translate="no">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);
     <span class="operator">~</span>QmlCoapSecureClient() override;

     Q_INVOKABLE <span class="type">void</span> setSecurityMode(<span class="type"><a href="qtcoap-module.html" translate="no">QtCoap</a></span><span class="operator">::</span>SecurityMode mode);
     Q_INVOKABLE <span class="type">void</span> sendGetRequest(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>host<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>path<span class="operator">,</span> <span class="type">int</span> port);
     Q_INVOKABLE <span class="type">void</span> setSecurityConfiguration(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>preSharedKey<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>identity);
     Q_INVOKABLE <span class="type">void</span> setSecurityConfiguration(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>localCertificatePath<span class="operator">,</span>
                                               <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>caCertificatePath<span class="operator">,</span>
                                               <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>privateKeyPath);
     Q_INVOKABLE <span class="type">void</span> disconnect();

 Q_SIGNALS:
     <span class="type">void</span> finished(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>result);

 <span class="keyword">private</span>:
     <span class="type"><a href="qcoapclient.html" translate="no">QCoapClient</a></span> <span class="operator">*</span>m_coapClient;
     <span class="type"><a href="qcoapsecurityconfiguration.html" translate="no">QCoapSecurityConfiguration</a></span> m_configuration;
     <span class="type"><a href="qtcoap-module.html" translate="no">QtCoap</a></span><span class="operator">::</span>SecurityMode m_securityMode;
 };
</pre>
<p>After that, register the <a href="qtcoap.html" translate="no">QtCoap</a> namespace, so that you can use the enums provided there:</p>
<pre class="cpp" translate="no">
 <span class="keyword">namespace</span> <span class="type">QCoapForeignNamespace</span>
 {
     Q_NAMESPACE
     QML_FOREIGN_NAMESPACE(<span class="type"><a href="qtcoap-module.html" translate="no">QtCoap</a></span>)
     QML_NAMED_ELEMENT(<span class="type"><a href="qtcoap-module.html" translate="no">QtCoap</a></span>)
 }
</pre>
<h4 id="adjusting-build-files">Adjusting Build Files</h4>
<p>To make the custom types available from QML, update the build system files accordingly.</p>
<h5 id="cmake">CMake</h5>
<p>For a CMake-based build, add the following to the <code translate="no">CMakeLists.txt</code>:</p>
<pre class="cpp" translate="no">
 qt_add_qml_module(quicksecureclient
     URI CoapSecureClientModule
     SOURCES
         qmlcoapsecureclient.cpp qmlcoapsecureclient.h
     QML_FILES
         FilePicker.qml
         Main.qml
 )
</pre>
<h5 id="qmake">qmake</h5>
<p>For a qmake build, modify the <code translate="no">quicksecureclient.pro</code> file in the following way:</p>
<pre class="cpp" translate="no">
 CONFIG += qmltypes
 QML_IMPORT_NAME = CoapSecureClientModule
 QML_IMPORT_MAJOR_VERSION = 1
     ...
 qml_resources.files = \
     qmldir \
     FilePicker.qml \
     Main.qml

 qml_resources.prefix = /qt/qml/CoapSecureClientModule

 RESOURCES += qml_resources
</pre>
<h4 id="using-new-qml-types">Using New QML Types</h4>
<p>Now, when the C++ classes are properly exposed to QML, you can use the new types.</p>
<h5 id="creating-the-client">Creating the Client</h5>
<p><code translate="no">CoapSecureClient</code> is instantiated from the <code translate="no">Main.qml</code> file. It handles the <code translate="no">QmlCoapSecureClient::finished()</code> signal and updates the UI accordingly:</p>
<pre class="qml" translate="no">
 <span class="type">CoapSecureClient</span> {
     <span class="name">id</span>: <span class="name">client</span>
     <span class="name">onFinished</span>: (<span class="keyword"></span>result) =&gt; {
         <span class="name">outputView</span>.<span class="name">text</span> <span class="operator">=</span> <span class="name">result</span>;
         <span class="name">statusLabel</span>.<span class="name">text</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;
         <span class="name">disconnectButton</span>.<span class="name">enabled</span> <span class="operator">=</span> <span class="number">true</span>;
     }
 }
</pre>
<p>The instance of <a href="qcoapclient.html" translate="no">QCoapClient</a> is created when the user selects or changes the security mode in the UI. The <code translate="no">QmlCoapSecureClient::setSecurityMode()</code> method is invoked from the QML code, when one of the security modes is selected:</p>
<pre class="qml" translate="no">
 <span class="type">ButtonGroup</span> {
     <span class="name">id</span>: <span class="name">securityModeGroup</span>
     <span class="name">onClicked</span>: {
         <span class="keyword">if</span> ((<span class="name">securityModeGroup</span>.<span class="name">checkedButton</span> <span class="operator">as</span> <span class="name">RadioButton</span>) <span class="operator">===</span> <span class="name">preSharedMode</span>)
             <span class="name">client</span>.<span class="name">setSecurityMode</span>(<span class="name">QtCoap</span>.<span class="name">SecurityMode</span>.<span class="name">PreSharedKey</span>);
         <span class="keyword">else</span>
             <span class="name">client</span>.<span class="name">setSecurityMode</span>(<span class="name">QtCoap</span>.<span class="name">SecurityMode</span>.<span class="name">Certificate</span>);
     }
 }
</pre>
<p>On the C++ side, this method creates a <a href="qcoapclient.html" translate="no">QCoapClient</a> and connects to its <a href="qcoapclient.html#finished" translate="no">finished</a>() and <a href="qcoapclient.html#error" translate="no">error</a>() signals. The class handles both signals internally, and forwards them to the new <code translate="no">finished()</code> signal.</p>
<pre class="cpp" translate="no">
 <span class="type">void</span> QmlCoapSecureClient<span class="operator">::</span>setSecurityMode(<span class="type"><a href="qtcoap-module.html" translate="no">QtCoap</a></span><span class="operator">::</span>SecurityMode mode)
 {
     <span class="comment">// Create a new client, if the security mode has changed</span>
     <span class="keyword">if</span> (m_coapClient <span class="operator">&amp;</span><span class="operator">&amp;</span> mode <span class="operator">!</span><span class="operator">=</span> m_securityMode) {
         <span class="keyword">delete</span> m_coapClient;
         m_coapClient <span class="operator">=</span> nullptr;
     }

     <span class="keyword">if</span> (<span class="operator">!</span>m_coapClient) {
         m_coapClient <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="qcoapclient.html" translate="no">QCoapClient</a></span>(mode);
         m_securityMode <span class="operator">=</span> mode;

         connect(m_coapClient<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="qcoapclient.html" translate="no">QCoapClient</a></span><span class="operator">::</span>finished<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span>
                 <span class="operator">[</span><span class="keyword">this</span><span class="operator">]</span>(<span class="type"><a href="qcoapreply.html" translate="no">QCoapReply</a></span> <span class="operator">*</span>reply) {
                     <span class="keyword">if</span> (<span class="operator">!</span>reply)
                         <span class="keyword">emit</span> finished(tr(<span class="string">&quot;Something went wrong, received a null reply&quot;</span>));
                     <span class="keyword">else</span> <span class="keyword">if</span> (reply<span class="operator">-</span><span class="operator">&gt;</span>errorReceived() <span class="operator">!</span><span class="operator">=</span> <span class="type"><a href="qtcoap-module.html" translate="no">QtCoap</a></span><span class="operator">::</span>Error<span class="operator">::</span>Ok)
                         <span class="keyword">emit</span> finished(errorMessage(reply<span class="operator">-</span><span class="operator">&gt;</span>errorReceived()));
                     <span class="keyword">else</span>
                         <span class="keyword">emit</span> finished(reply<span class="operator">-</span><span class="operator">&gt;</span>message()<span class="operator">.</span>payload());
                 });

         connect(m_coapClient<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="qcoapclient.html" translate="no">QCoapClient</a></span><span class="operator">::</span>error<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span>
                 <span class="operator">[</span><span class="keyword">this</span><span class="operator">]</span>(<span class="type"><a href="qcoapreply.html" translate="no">QCoapReply</a></span> <span class="operator">*</span><span class="operator">,</span> <span class="type"><a href="qtcoap-module.html" translate="no">QtCoap</a></span><span class="operator">::</span>Error errorCode) {
                     <span class="keyword">emit</span> finished(errorMessage(errorCode));
                 });
     }
 }
</pre>
<h5 id="sending-a-request">Sending a Request</h5>
<p>Click the <b translate="no">Send Request</b> button to set the security configuration based on the selected security mode and send a <code translate="no">GET</code> request:</p>
<pre class="qml" translate="no">
 <span class="type">Button</span> {
     <span class="name">id</span>: <span class="name">requestButton</span>
     <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Send Request&quot;</span>)
     <span class="name">enabled</span>: <span class="name">securityModeGroup</span>.<span class="name">checkState</span> <span class="operator">!==</span> <span class="name">Qt</span>.<span class="name">Unchecked</span>

     <span class="name">onClicked</span>: {
         <span class="name">outputView</span>.<span class="name">text</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;
         <span class="keyword">if</span> ((<span class="name">securityModeGroup</span>.<span class="name">checkedButton</span> <span class="operator">as</span> <span class="name">RadioButton</span>) <span class="operator">===</span> <span class="name">preSharedMode</span>)
             <span class="name">client</span>.<span class="name">setSecurityConfiguration</span>(<span class="name">pskField</span>.<span class="name">text</span>, <span class="name">identityField</span>.<span class="name">text</span>);
         <span class="keyword">else</span>
             <span class="name">client</span>.<span class="name">setSecurityConfiguration</span>(<span class="name">localCertificatePicker</span>.<span class="name">selectedFile</span>,
                                             <span class="name">caCertificatePicker</span>.<span class="name">selectedFile</span>,
                                             <span class="name">privateKeyPicker</span>.<span class="name">selectedFile</span>);

         <span class="name">client</span>.<span class="name">sendGetRequest</span>(<span class="name">hostComboBox</span>.<span class="name">editText</span>, <span class="name">resourceField</span>.<span class="name">text</span>,
                               <span class="name">parseInt</span>(<span class="name">portField</span>.<span class="name">text</span>));

         <span class="name">statusLabel</span>.<span class="name">text</span> <span class="operator">=</span> <span class="name">qsTr</span>(<span class="string">&quot;Sending request to %1%2...&quot;</span>).<span class="name">arg</span>(<span class="name">hostComboBox</span>.<span class="name">editText</span>)
                                                              .<span class="name">arg</span>(<span class="name">resourceField</span>.<span class="name">text</span>);
     }
 }
</pre>
<p>There are two overloads for the <code translate="no">setSecurityConfiguration</code> method.</p>
<p>The overload for the PSK mode simply sets the client identity and the pre-shared key:</p>
<pre class="cpp" translate="no">
 <span class="type">void</span>
 QmlCoapSecureClient<span class="operator">::</span>setSecurityConfiguration(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>preSharedKey<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>identity)
 {
     <span class="type"><a href="qcoapsecurityconfiguration.html" translate="no">QCoapSecurityConfiguration</a></span> configuration;
     configuration<span class="operator">.</span>setPreSharedKey(preSharedKey<span class="operator">.</span>toUtf8());
     configuration<span class="operator">.</span>setPreSharedKeyIdentity(identity<span class="operator">.</span>toUtf8());
     m_configuration <span class="operator">=</span> configuration;
 }
</pre>
<p>And the overload for X.509 certificates reads the certificate files and the private key and sets the security configuration:</p>
<pre class="cpp" translate="no">
 <span class="type">void</span> QmlCoapSecureClient<span class="operator">::</span>setSecurityConfiguration(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>localCertificatePath<span class="operator">,</span>
                                                    <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>caCertificatePath<span class="operator">,</span>
                                                    <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>privateKeyPath)
 {
     <span class="type"><a href="qcoapsecurityconfiguration.html" translate="no">QCoapSecurityConfiguration</a></span> configuration;

     <span class="keyword">const</span> <span class="keyword">auto</span> localCerts <span class="operator">=</span>
             <span class="type"><a href="../qtnetwork/qsslcertificate.html" translate="no">QSslCertificate</a></span><span class="operator">::</span>fromPath(<span class="type"><a href="../qtcore/qurl.html" translate="no">QUrl</a></span>(localCertificatePath)<span class="operator">.</span>toLocalFile()<span class="operator">,</span> <span class="type"><a href="../qtnetwork/qssl.html" translate="no">QSsl</a></span><span class="operator">::</span>Pem<span class="operator">,</span>
                                       <span class="type"><a href="../qtnetwork/qsslcertificate.html" translate="no">QSslCertificate</a></span><span class="operator">::</span>PatternSyntax<span class="operator">::</span>FixedString);
     <span class="keyword">if</span> (localCerts<span class="operator">.</span>isEmpty())
         qCWarning(lcCoapClient<span class="operator">,</span> <span class="string">&quot;The specified local certificate file is not valid.&quot;</span>);
     <span class="keyword">else</span>
         configuration<span class="operator">.</span>setLocalCertificateChain(localCerts<span class="operator">.</span>toVector());

     <span class="keyword">const</span> <span class="keyword">auto</span> caCerts <span class="operator">=</span> <span class="type"><a href="../qtnetwork/qsslcertificate.html" translate="no">QSslCertificate</a></span><span class="operator">::</span>fromPath(<span class="type"><a href="../qtcore/qurl.html" translate="no">QUrl</a></span>(caCertificatePath)<span class="operator">.</span>toLocalFile()<span class="operator">,</span> <span class="type"><a href="../qtnetwork/qssl.html" translate="no">QSsl</a></span><span class="operator">::</span>Pem<span class="operator">,</span>
                                                    <span class="type"><a href="../qtnetwork/qsslcertificate.html" translate="no">QSslCertificate</a></span><span class="operator">::</span>PatternSyntax<span class="operator">::</span>FixedString);
     <span class="keyword">if</span> (caCerts<span class="operator">.</span>isEmpty())
         qCWarning(lcCoapClient<span class="operator">,</span> <span class="string">&quot;The specified CA certificate file is not valid.&quot;</span>);
     <span class="keyword">else</span>
         configuration<span class="operator">.</span>setCaCertificates(caCerts<span class="operator">.</span>toVector());

     <span class="type"><a href="../qtcore/qfile.html" translate="no">QFile</a></span> privateKey(<span class="type"><a href="../qtcore/qurl.html" translate="no">QUrl</a></span>(privateKeyPath)<span class="operator">.</span>toLocalFile());
     <span class="keyword">if</span> (privateKey<span class="operator">.</span>open(<span class="type"><a href="../qtcore/qiodevice.html" translate="no">QIODevice</a></span><span class="operator">::</span>ReadOnly)) {
         <span class="type"><a href="qcoapprivatekey.html" translate="no">QCoapPrivateKey</a></span> key(privateKey<span class="operator">.</span>readAll()<span class="operator">,</span> <span class="type"><a href="../qtnetwork/qssl.html" translate="no">QSsl</a></span><span class="operator">::</span>Ec);
         configuration<span class="operator">.</span>setPrivateKey(key);
     } <span class="keyword">else</span> {
         qCWarning(lcCoapClient) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Unable to read the specified private key file&quot;</span>
                                 <span class="operator">&lt;</span><span class="operator">&lt;</span> privateKeyPath;
     }
     m_configuration <span class="operator">=</span> configuration;
 }
</pre>
<p>After setting the security configuration, the <code translate="no">sendGetRequest</code> method sets the request URL and sends a <code translate="no">GET</code> request:</p>
<pre class="cpp" translate="no">
 <span class="type">void</span> QmlCoapSecureClient<span class="operator">::</span>sendGetRequest(<span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>host<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>path<span class="operator">,</span> <span class="type">int</span> port)
 {
     <span class="keyword">if</span> (<span class="operator">!</span>m_coapClient)
         <span class="keyword">return</span>;

     m_coapClient<span class="operator">-</span><span class="operator">&gt;</span>setSecurityConfiguration(m_configuration);

     <span class="type"><a href="../qtcore/qurl.html" translate="no">QUrl</a></span> url;
     url<span class="operator">.</span>setHost(host);
     url<span class="operator">.</span>setPath(path);
     url<span class="operator">.</span>setPort(port);
     m_coapClient<span class="operator">-</span><span class="operator">&gt;</span>get(url);
 }
</pre>
<p>When sending the first request, a handshake with the CoAP server is performed. After the handshake is successfully done, all the subsequent messages are encrypted, and changing the security configuration after a successful handshake won't have any effect. If you want to change it, or change the host, you need to disconnect first.</p>
<pre class="cpp" translate="no">
 <span class="type">void</span> QmlCoapSecureClient<span class="operator">::</span>disconnect()
 {
     <span class="keyword">if</span> (m_coapClient)
         m_coapClient<span class="operator">-</span><span class="operator">&gt;</span>disconnect();
 }
</pre>
<p>This will abort the handshake and close the open sockets.</p>
<p>For the authentication using X.509 certificates, the certificate files need to be specified. The <code translate="no">FilePicker</code> component is used for this purpose. It combines a text field and a button for opening a file dialog when the button is pressed:</p>
<pre class="qml" translate="no">
 <span class="type">Item</span> {
     <span class="name">id</span>: <span class="name">filePicker</span>

     property <span class="type"><a href="../qtqml/qml-string.html" translate="no">string</a></span> <span class="name">dialogText</span>
     property <span class="type">alias</span> <span class="name">selectedFile</span>: <span class="name">filePathField</span>.<span class="name">text</span>

     <span class="name">height</span>: <span class="name">addFileButton</span>.<span class="name">height</span>

     <span class="type">FileDialog</span> {
         <span class="name">id</span>: <span class="name">fileDialog</span>
         <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;Please Choose %1&quot;</span>).<span class="name">arg</span>(<span class="name">filePicker</span>.<span class="name">dialogText</span>)
         <span class="name">currentFolder</span>: <span class="name">StandardPaths</span>.<span class="name">writableLocation</span>(<span class="name">StandardPaths</span>.<span class="name">HomeLocation</span>)
         <span class="name">fileMode</span>: <span class="name">FileDialog</span>.<span class="name">OpenFile</span>
         <span class="name">onAccepted</span>: <span class="name">filePathField</span>.<span class="name">text</span> <span class="operator">=</span> <span class="name">fileDialog</span>.<span class="name">selectedFile</span>
     }

     <span class="type">RowLayout</span> {
         <span class="name">anchors</span>.fill: <span class="name">parent</span>
         <span class="type">TextField</span> {
             <span class="name">id</span>: <span class="name">filePathField</span>
             <span class="name">placeholderText</span>: <span class="name">qsTr</span>(<span class="string">&quot;&lt;%1&gt;&quot;</span>).<span class="name">arg</span>(<span class="name">filePicker</span>.<span class="name">dialogText</span>)
             <span class="name">inputMethodHints</span>: <span class="name">Qt</span>.<span class="name">ImhUrlCharactersOnly</span>
             <span class="name">selectByMouse</span>: <span class="number">true</span>
             <span class="name">Layout</span>.fillWidth: <span class="number">true</span>
         }

         <span class="type">Button</span> {
             <span class="name">id</span>: <span class="name">addFileButton</span>
             <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Add %1&quot;</span>).<span class="name">arg</span>(<span class="name">filePicker</span>.<span class="name">dialogText</span>)
             <span class="name">onClicked</span>: <span class="name">fileDialog</span>.<span class="name">open</span>()
         }
     }
 }
</pre>
<p><code translate="no">FilePicker</code> is instantiated several times in the <code translate="no">Main.qml</code> file for creating input fields for certificates and the private key:</p>
<pre class="qml" translate="no">
 <span class="type">FilePicker</span> {
     <span class="name">id</span>: <span class="name">localCertificatePicker</span>
     <span class="name">dialogText</span>: <span class="name">qsTr</span>(<span class="string">&quot;Local Certificate&quot;</span>)
     <span class="name">enabled</span>: (<span class="name">securityModeGroup</span>.<span class="name">checkedButton</span> <span class="operator">as</span> <span class="name">RadioButton</span>) <span class="operator">===</span> <span class="name">certificateMode</span>
     <span class="name">Layout</span>.columnSpan: <span class="number">2</span>
     <span class="name">Layout</span>.fillWidth: <span class="number">true</span>
 }

 <span class="type">FilePicker</span> {
     <span class="name">id</span>: <span class="name">caCertificatePicker</span>
     <span class="name">dialogText</span>: <span class="name">qsTr</span>(<span class="string">&quot;CA Certificate&quot;</span>)
     <span class="name">enabled</span>: (<span class="name">securityModeGroup</span>.<span class="name">checkedButton</span> <span class="operator">as</span> <span class="name">RadioButton</span>) <span class="operator">===</span> <span class="name">certificateMode</span>
     <span class="name">Layout</span>.columnSpan: <span class="number">2</span>
     <span class="name">Layout</span>.fillWidth: <span class="number">true</span>
 }

 <span class="type">FilePicker</span> {
     <span class="name">id</span>: <span class="name">privateKeyPicker</span>
     <span class="name">dialogText</span>: <span class="name">qsTr</span>(<span class="string">&quot;Private Key&quot;</span>)
     <span class="name">enabled</span>: (<span class="name">securityModeGroup</span>.<span class="name">checkedButton</span> <span class="operator">as</span> <span class="name">RadioButton</span>) <span class="operator">===</span> <span class="name">certificateMode</span>
     <span class="name">Layout</span>.columnSpan: <span class="number">2</span>
     <span class="name">Layout</span>.fillWidth: <span class="number">true</span>
 }
</pre>
<h4 id="setting-up-a-secure-coap-server">Setting Up a Secure CoAP Server</h4>
<p>To run this example, you need to have a secure CoAP server supporting either PSK or Certificate modes (or both). You have the following options:</p>
<ul>
<li>Manually build and run a secure CoAP server using, for example, <a href="https://github.com/obgm/libcoap" translate="no">libcoap</a>, <a href="https://github.com/eclipse/californium" translate="no">Californium</a>, <a href="https://github.com/keith-cullen/FreeCoAP" translate="no">FreeCoAP</a>, or any other CoAP library which supports DTLS.</li>
<li>Use the ready Docker images available at Docker Hub, which build and run the secure CoAP servers suitable for our example. The steps required for using the docker-based CoAP servers are described below.</li>
</ul>
<h5 id="setting-up-a-server-for-psk-mode">Setting Up a Server For PSK Mode</h5>
<p>The following command pulls the docker container for a secure CoAP server based on <a href="https://github.com/eclipse/californium/tree/master/demo-apps/cf-plugtest-server" translate="no">Californium plugtest</a> (which is not secure by default) from the Docker Hub and starts it:</p>
<pre class="cpp plain" translate="no">
 docker run --name coap-test-server -d --rm -p 5683:5683/udp -p 5684:5684/udp tqtc/coap-californium-test-server:3.8&#x2e;0
</pre>
<p>The CoAP test server will be reachable on ports <i>5683</i> (non-secure) and <i>5684</i> (secure). For instructions on retrieving the IP address see <a href="qtcoap-quicksecureclient-example.html#getting-the-ip-address" translate="no">Getting The IP Address</a>.</p>
<p>To run the example with this server, you need to set the pre-shared key to <code translate="no">secretPSK</code> and the identity to <code translate="no">Client_identity</code>.</p>
<h5 id="setting-up-a-server-for-certificate-mode">Setting Up a Server For Certificate Mode</h5>
<p>The docker image of the secure server using authentication with X.509 certificates is based on the <a href="https://github.com/keith-cullen/FreeCoAP/tree/master/sample/time_server" translate="no">time server</a> example from the FreeCoAP library. The following command pulls the container from Docker Hub and starts it:</p>
<pre class="cpp plain" translate="no">
 docker run --name coap-time-server -d --rm -p 5684:5684/udp tqtc/coap-secure-time-server:freecoap
</pre>
<p>For instructions on retrieving the IP address see <a href="qtcoap-quicksecureclient-example.html#getting-the-ip-address" translate="no">Getting The IP Address</a>. The CoAP test server will be reachable by the retrieved IP address on port <i>5684</i> and resource path <code translate="no">/time</code>.</p>
<p>To run the example with this server, you need to specify the certificate files required by the server. They are located in the docker container, under <code translate="no">/root/certs</code> directory. To copy them to a local directory, use the following command:</p>
<pre class="cpp plain" translate="no">
 docker cp &lt;container_id&gt;:/root/certs &lt;local_directory_path&gt;
</pre>
<p>For example:</p>
<pre class="cpp plain" translate="no">
 $ docker cp 5e46502df88f:/root/certs ~/
</pre>
<p>The instructions for getting the container ID are described below.</p>
<h5 id="getting-the-ip-address">Getting The IP Address</h5>
<p>To find out the IP address of a docker container, first retrieve the container ID by running the <code translate="no">docker ps</code> command, which will output something like:</p>
<pre class="cpp plain" translate="no">
 $ docker ps
 CONTAINER ID        IMAGE
 5e46502df88f        tqtc/coap-californium-test-server:3.8&#x2e;0
</pre>
<p>Then you can obtain the IP address with the following command:</p>
<pre class="cpp plain" translate="no">
 docker inspect &lt;container_id&gt; | grep IPAddress
</pre>
<p>For example:</p>
<pre class="cpp plain" translate="no">
 $ docker inspect 5e46502df88f | grep IPAddress
 ..&#x2e;
 &quot;IPAddress&quot;: &quot;172.17.0&#x2e;2&quot;,
 ..&#x2e;
</pre>
<h5 id="terminating-a-docker-container">Terminating a Docker Container</h5>
<p>To terminate a docker container after usage, use the following command:</p>
<pre class="cpp plain" translate="no">
 docker stop &lt;container_id&gt;
</pre>
<p>The <code translate="no">&lt;container_id&gt;</code> here is the same as retrieved by the <code translate="no">docker ps</code> command.</p>
<p>Files:</p>
<ul>
<li><a href="qtcoap-quicksecureclient-cmakelists-txt.html" translate="no">quicksecureclient/CMakeLists.txt</a></li>
<li><a href="qtcoap-quicksecureclient-filepicker-qml.html" translate="no">quicksecureclient/FilePicker.qml</a></li>
<li><a href="qtcoap-quicksecureclient-main-qml.html" translate="no">quicksecureclient/Main.qml</a></li>
<li><a href="qtcoap-quicksecureclient-main-cpp.html" translate="no">quicksecureclient/main.cpp</a></li>
<li><a href="qtcoap-quicksecureclient-qmlcoapsecureclient-cpp.html" translate="no">quicksecureclient/qmlcoapsecureclient.cpp</a></li>
<li><a href="qtcoap-quicksecureclient-qmlcoapsecureclient-h.html" translate="no">quicksecureclient/qmlcoapsecureclient.h</a></li>
<li><a href="qtcoap-quicksecureclient-qmldir.html" translate="no">quicksecureclient/qmldir</a></li>
<li><a href="qtcoap-quicksecureclient-quicksecureclient-pro.html" translate="no">quicksecureclient/quicksecureclient.pro</a></li>
</ul>
</div>
<!-- @@@quicksecureclient -->
        </div>
       </div>
   </div>
   </div>
</div>
<div class="footer">
   <p>
   <acronym title="Copyright">&copy;</acronym> 2023 The Qt Company Ltd.
   Documentation contributions included herein are the copyrights of
   their respective owners.<br/>    The documentation provided herein is licensed under the terms of the    <a href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation    License version 1.3</a> as published by the Free Software Foundation.<br/>    Qt and respective logos are <a href="https://doc.qt.io/qt/trademarks.html">    trademarks</a> of The Qt Company Ltd. in Finland and/or other countries
   worldwide. All other trademarks are property of their respective owners. </p>
</div>
</body>
</html>
