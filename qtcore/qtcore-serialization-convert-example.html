<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<!-- convert.qdoc -->
  <meta name="description" content="The Convert example demonstrates how to convert between different serialization formats.">
  <title>Convert Example | Qt Core 6.6.0</title>
  <link rel="stylesheet" type="text/css" href="style/offline-simple.css" />
  <script type="text/javascript">
    document.getElementsByTagName("link").item(0).setAttribute("href", "style/offline.css");
    // loading style sheet breaks anchors that were jumped to before
    // so force jumping to anchor again
    setTimeout(function() {
        var anchor = location.hash;
        // need to jump to different anchor first (e.g. none)
        location.hash = "#";
        setTimeout(function() {
            location.hash = anchor;
        }, 0);
    }, 0);
  </script>
</head>
<body>
<div class="header" id="qtdocheader">
    <div class="main">
    <div class="main-rounded">
        <div class="navigationbar">
        <ul>
<li><a href="../qtdoc/index.html" translate="no">Qt 6.6</a></li>
<li><a href="qtcore-index.html" translate="no">Qt Core</a></li>
<li>Convert Example</li>
<li id="buildversion"><a href="qtcore-index.html" translate="no">Qt 6.6&#x2e;0 Reference Documentation</a></li>
    </ul>
    </div>
</div>
<div class="content">
<div class="line">
<div class="content mainContent">
<div class="sidebar">
<div class="toc">
<h3 id="toc">Contents</h3>
<ul>
<li class="level1"><a href="#the-converter-class">The Converter Class</a></li>
<li class="level1"><a href="#the-cborconverter-class">The CborConverter Class</a></li>
<li class="level1"><a href="#the-datastreamconverter-class">The DataStreamConverter Class</a></li>
<li class="level1"><a href="#the-jsonconverter-class">The JsonConverter Class</a></li>
<li class="level1"><a href="#the-xmlconverter-class">The XmlConverter Class</a></li>
<li class="level1"><a href="#the-textconverter-class">The TextConverter Class</a></li>
<li class="level1"><a href="#the-nullconverter-class">The NullConverter Class</a></li>
</ul>
</div>
<div class="sidebar-content" id="sidebar-content"></div></div>
<h1 class="title">Convert Example</h1>
<!-- $$$serialization/convert-brief -->
<p>The Convert example demonstrates how to convert between different serialization formats.</p>
<!-- @@@serialization/convert -->
<!-- $$$serialization/convert-description -->
<div class="descr" id="details">
<p>The Convert example converts between the serialization formats JSON, CBOR, XML, <a href="qdatastream.html" translate="no">QDataStream</a> and text. It can also auto detect the format being used. Not all formats support both input and output, and they have different sets of which types they support. <a href="qdatastream.html" translate="no">QDataStream</a> and XML are the richest, followed by CBOR, then JSON, and then the plain text one.</p>
<p class="centerAlign"><img src="images/convert.png" alt="" /></p><h4 id="the-converter-class">The Converter Class</h4>
<p>The Converter class is the abstract superclass for all the converters to and from all the formats. They all convert to and from the <a href="qvariant.html" translate="no">QVariant</a> class, which is used to represent all the datastructures internally. The name() function returns the name of the converter. The directions() function is used to determine if a converter can be used for input, output, or both. The outputOptions() and optionsHelp() functions are used to get and query which options are used by the different converters. The probeFile() function is used to determine if a file has the same file format as the converter. The loadFile() function deserializes the given file, while the saveFile() serializes to the given file.</p>
<h4 id="the-cborconverter-class">The CborConverter Class</h4>
<p>The CborConverter class shows how to serialize to and from the CBOR-format. There is also a CborDiagnosticDumper class to output in CBOR diagnostic notation. That is similar to JSON, but not exactly, because it allows displaying the contents of a CBOR stream losslessly, while a conversion to JSON is lossy.</p>
<p>The convertCborValue() function is used to convert a <a href="qcborvalue.html" translate="no">QCborValue</a> to a <a href="qvariant.html" translate="no">QVariant</a>. It uses the helper functions convertCborMap() and convertCborArray().</p>
<pre class="cpp" translate="no">
 <span class="keyword">static</span> <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span> convertCborMap(<span class="keyword">const</span> <span class="type"><a href="qcbormap.html" translate="no">QCborMap</a></span> <span class="operator">&amp;</span>map)
 {
     VariantOrderedMap result;
     result<span class="operator">.</span>reserve(map<span class="operator">.</span>size());
     <span class="keyword">for</span> (<span class="keyword">auto</span> pair : map)
         result<span class="operator">.</span>append({ convertCborValue(pair<span class="operator">.</span>first)<span class="operator">,</span> convertCborValue(pair<span class="operator">.</span>second) });
     <span class="keyword">return</span> <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span><span class="operator">::</span>fromValue(result);
 }

 <span class="keyword">static</span> <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span> convertCborArray(<span class="keyword">const</span> <span class="type"><a href="qcborarray.html" translate="no">QCborArray</a></span> <span class="operator">&amp;</span>array)
 {
     <span class="type">QVariantList</span> result;
     result<span class="operator">.</span>reserve(array<span class="operator">.</span>size());
     <span class="keyword">for</span> (<span class="keyword">auto</span> value : array)
         result<span class="operator">.</span>append(convertCborValue(value));
     <span class="keyword">return</span> result;
 }

 <span class="keyword">static</span> <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span> convertCborValue(<span class="keyword">const</span> <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span> <span class="operator">&amp;</span>value)
 {
     <span class="keyword">if</span> (value<span class="operator">.</span>isArray())
         <span class="keyword">return</span> convertCborArray(value<span class="operator">.</span>toArray());
     <span class="keyword">if</span> (value<span class="operator">.</span>isMap())
         <span class="keyword">return</span> convertCborMap(value<span class="operator">.</span>toMap());
     <span class="keyword">return</span> value<span class="operator">.</span>toVariant();
 }
</pre>
<p>A CBOR-file is read using loadFile() function.</p>
<pre class="cpp" translate="no">
 <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span> CborConverter<span class="operator">::</span>loadFile(<span class="type"><a href="qiodevice.html" translate="no">QIODevice</a></span> <span class="operator">*</span>f<span class="operator">,</span> <span class="keyword">const</span> Converter <span class="operator">*</span><span class="operator">&amp;</span>outputConverter) <span class="keyword">const</span>
 {
     <span class="keyword">const</span> <span class="type">char</span> <span class="operator">*</span>ptr <span class="operator">=</span> nullptr;
     <span class="keyword">if</span> (<span class="keyword">auto</span> file <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span><span class="type"><a href="qfile.html" translate="no">QFile</a></span> <span class="operator">*</span><span class="operator">&gt;</span>(f))
         ptr <span class="operator">=</span> <span class="keyword">reinterpret_cast</span><span class="operator">&lt;</span><span class="type">char</span> <span class="operator">*</span><span class="operator">&gt;</span>(file<span class="operator">-</span><span class="operator">&gt;</span>map(<span class="number">0</span><span class="operator">,</span> file<span class="operator">-</span><span class="operator">&gt;</span>size()));

     <span class="type"><a href="qbytearray.html" translate="no">QByteArray</a></span> mapped <span class="operator">=</span> <span class="type"><a href="qbytearray.html" translate="no">QByteArray</a></span><span class="operator">::</span>fromRawData(ptr<span class="operator">,</span> ptr <span class="operator">?</span> f<span class="operator">-</span><span class="operator">&gt;</span>size() : <span class="number">0</span>);
     <span class="type"><a href="qcborstreamreader.html" translate="no">QCborStreamReader</a></span> reader(mapped);
     <span class="keyword">if</span> (<span class="operator">!</span>ptr)
         reader<span class="operator">.</span>setDevice(f);

     <span class="keyword">if</span> (reader<span class="operator">.</span>isTag() <span class="operator">&amp;</span><span class="operator">&amp;</span> reader<span class="operator">.</span>toTag() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="qtcborcommon.html#QCborKnownTags-enum" translate="no">QCborKnownTags</a></span><span class="operator">::</span>Signature)
         reader<span class="operator">.</span>next();

     <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span> contents <span class="operator">=</span> <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span><span class="operator">::</span>fromCbor(reader);
     <span class="type"><a href="qttypes.html#qint64-typedef" translate="no">qint64</a></span> offset <span class="operator">=</span> reader<span class="operator">.</span>currentOffset();
     <span class="keyword">if</span> (reader<span class="operator">.</span>lastError()) {
         fprintf(stderr<span class="operator">,</span> <span class="string">&quot;Error loading CBOR contents (byte %lld): %s\n&quot;</span><span class="operator">,</span> offset<span class="operator">,</span>
                 <a href="qstring.html#qPrintable" translate="no">qPrintable</a>(reader<span class="operator">.</span>lastError()<span class="operator">.</span>toString()));
         fprintf(stderr<span class="operator">,</span> <span class="string">&quot; bytes: %s\n&quot;</span><span class="operator">,</span>
                 (ptr <span class="operator">?</span> mapped<span class="operator">.</span>mid(offset<span class="operator">,</span> <span class="number">9</span>) : f<span class="operator">-</span><span class="operator">&gt;</span>read(<span class="number">9</span>))<span class="operator">.</span>toHex(<span class="char">' '</span>)<span class="operator">.</span>constData());
         exit(EXIT_FAILURE);
     } <span class="keyword">else</span> <span class="keyword">if</span> (offset <span class="operator">&lt;</span> mapped<span class="operator">.</span>size() <span class="operator">|</span><span class="operator">|</span> (<span class="operator">!</span>ptr <span class="operator">&amp;</span><span class="operator">&amp;</span> f<span class="operator">-</span><span class="operator">&gt;</span>bytesAvailable())) {
         fprintf(stderr<span class="operator">,</span> <span class="string">&quot;Warning: bytes remaining at the end of the CBOR stream\n&quot;</span>);
     }

     <span class="keyword">if</span> (outputConverter <span class="operator">=</span><span class="operator">=</span> nullptr)
         outputConverter <span class="operator">=</span> <span class="operator">&amp;</span>cborDiagnosticDumper;
     <span class="keyword">else</span> <span class="keyword">if</span> (outputConverter <span class="operator">=</span><span class="operator">=</span> null)
         <span class="keyword">return</span> <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span>();
     <span class="keyword">else</span> <span class="keyword">if</span> (<span class="operator">!</span>outputConverter<span class="operator">-</span><span class="operator">&gt;</span>outputOptions()<span class="operator">.</span>testFlag(SupportsArbitraryMapKeys))
         <span class="keyword">return</span> contents<span class="operator">.</span>toVariant();
     <span class="keyword">return</span> convertCborValue(contents);
 }
</pre>
<p>The convertFromVariant() function is used to convert a <a href="qvariant.html" translate="no">QVariant</a> to a <a href="qcborvalue.html" translate="no">QCborValue</a>.</p>
<pre class="cpp" translate="no">
 <span class="keyword">static</span> <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span> convertFromVariant(<span class="keyword">const</span> <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span> <span class="operator">&amp;</span>v<span class="operator">,</span> TrimFloatingPoint fpTrimming)
 {
     <span class="keyword">if</span> (v<span class="operator">.</span>userType() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="qmetatype.html" translate="no">QMetaType</a></span><span class="operator">::</span><span class="type">QVariantList</span>) {
         <span class="keyword">const</span> <span class="type">QVariantList</span> list <span class="operator">=</span> v<span class="operator">.</span>toList();
         <span class="type"><a href="qcborarray.html" translate="no">QCborArray</a></span> array;
         <span class="keyword">for</span> (<span class="keyword">const</span> <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span> <span class="operator">&amp;</span>v : list)
             array<span class="operator">.</span>append(convertFromVariant(v<span class="operator">,</span> fpTrimming));

         <span class="keyword">return</span> array;
     }

     <span class="keyword">if</span> (v<span class="operator">.</span>userType() <span class="operator">=</span><span class="operator">=</span> <a href="qmetatype.html#qMetaTypeId" translate="no">qMetaTypeId</a><span class="operator">&lt;</span>VariantOrderedMap<span class="operator">&gt;</span>()) {
         <span class="keyword">const</span> <span class="keyword">auto</span> m <span class="operator">=</span> qvariant_cast<span class="operator">&lt;</span>VariantOrderedMap<span class="operator">&gt;</span>(v);
         <span class="type"><a href="qcbormap.html" translate="no">QCborMap</a></span> map;
         <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <span class="operator">&amp;</span>pair : m)
             map<span class="operator">.</span>insert(convertFromVariant(pair<span class="operator">.</span>first<span class="operator">,</span> fpTrimming)<span class="operator">,</span>
                        convertFromVariant(pair<span class="operator">.</span>second<span class="operator">,</span> fpTrimming));
         <span class="keyword">return</span> map;
     }

     <span class="keyword">if</span> (v<span class="operator">.</span>userType() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="qmetatype.html" translate="no">QMetaType</a></span><span class="operator">::</span>Double <span class="operator">&amp;</span><span class="operator">&amp;</span> fpTrimming <span class="operator">!</span><span class="operator">=</span> Double) {
         <span class="type">float</span> f <span class="operator">=</span> <span class="type">float</span>(v<span class="operator">.</span>toDouble());
         <span class="keyword">if</span> (fpTrimming <span class="operator">=</span><span class="operator">=</span> Float16)
             <span class="keyword">return</span> <span class="type">float</span>(qfloat16(f));
         <span class="keyword">return</span> f;
     }

     <span class="keyword">return</span> <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span><span class="operator">::</span>fromVariant(v);
 }
</pre>
<p>A CBOR-file is written using the saveFile() function.</p>
<pre class="cpp" translate="no">
 <span class="type">void</span> CborConverter<span class="operator">::</span>saveFile(<span class="type"><a href="qiodevice.html" translate="no">QIODevice</a></span> <span class="operator">*</span>f<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qvariant.html" translate="no">QVariant</a></span> <span class="operator">&amp;</span>contents<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qstringlist.html" translate="no">QStringList</a></span> <span class="operator">&amp;</span>options) <span class="keyword">const</span>
 {
 <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span> v <span class="operator">=</span>
     convertFromVariant(contents<span class="operator">,</span>
                        useFloat16 <span class="operator">=</span><span class="operator">=</span> Always <span class="operator">?</span> Float16 : useFloat <span class="operator">=</span><span class="operator">=</span> Always <span class="operator">?</span> Float : Double);
 <span class="type"><a href="qcborstreamwriter.html" translate="no">QCborStreamWriter</a></span> writer(f);
 <span class="keyword">if</span> (useSignature)
     writer<span class="operator">.</span>append(<span class="type"><a href="qtcborcommon.html#QCborKnownTags-enum" translate="no">QCborKnownTags</a></span><span class="operator">::</span>Signature);

 <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span><span class="operator">::</span>EncodingOptions opts;
 <span class="keyword">if</span> (useIntegers)
     opts <span class="operator">|</span><span class="operator">=</span> <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span><span class="operator">::</span>UseIntegers;
 <span class="keyword">if</span> (useFloat <span class="operator">!</span><span class="operator">=</span> No)
     opts <span class="operator">|</span><span class="operator">=</span> <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span><span class="operator">::</span>UseFloat;
 <span class="keyword">if</span> (useFloat16 <span class="operator">!</span><span class="operator">=</span> No)
     opts <span class="operator">|</span><span class="operator">=</span> <span class="type"><a href="qcborvalue.html" translate="no">QCborValue</a></span><span class="operator">::</span>UseFloat16;
 v<span class="operator">.</span>toCbor(writer<span class="operator">,</span> opts);
 }
</pre>
<h4 id="the-datastreamconverter-class">The DataStreamConverter Class</h4>
<p>The DataStreamConverter class is used to serialize to and from the <a href="qdatastream.html" translate="no">QDataStream</a> format. There is also the DebugTextDumper class for outputting the data lossless in a non-standardized human readable format.</p>
<h4 id="the-jsonconverter-class">The JsonConverter Class</h4>
<p>The JsonConverter class is used to serialize to and from the JSON-format.</p>
<h4 id="the-xmlconverter-class">The XmlConverter Class</h4>
<p>The XmlConverter class is used to serialize to and from the XML-format.</p>
<h4 id="the-textconverter-class">The TextConverter Class</h4>
<p>The TextConverter class is used to serialize to and from a text format.</p>
<h4 id="the-nullconverter-class">The NullConverter Class</h4>
<p>The NullConverter class is an output serializer that does nothing.</p>
<p><a href="https://code.qt.io/cgit/qt/qtbase.git/tree/examples/corelib/serialization/convert?h=6.6" translate="no">Example project @ code.qt.io</a></p>
</div>
<p><b>See also </b><a href="cbor.html" translate="no">CBOR Support in Qt</a> and <a href="json.html" translate="no">JSON Support in Qt</a>.</p>
<!-- @@@serialization/convert -->
        </div>
       </div>
   </div>
   </div>
</div>
<div class="footer">
   <p>
   <acronym title="Copyright">&copy;</acronym> 2023 The Qt Company Ltd.
   Documentation contributions included herein are the copyrights of
   their respective owners.<br/>    The documentation provided herein is licensed under the terms of the    <a href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation    License version 1.3</a> as published by the Free Software Foundation.<br/>    Qt and respective logos are <a href="https://doc.qt.io/qt/trademarks.html">    trademarks</a> of The Qt Company Ltd. in Finland and/or other countries
   worldwide. All other trademarks are property of their respective owners. </p>
</div>
</body>
</html>
