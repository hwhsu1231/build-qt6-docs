<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<!-- colorpalette-example.qdoc -->
  <meta name="description" content="Example of how to create a RESTful API server using the QHttpServer.">
  <title>RESTful Color Palette Server | Qt HTTP Server 6.6.0</title>
  <link rel="stylesheet" type="text/css" href="style/offline-simple.css" />
  <script type="text/javascript">
    document.getElementsByTagName("link").item(0).setAttribute("href", "style/offline.css");
    // loading style sheet breaks anchors that were jumped to before
    // so force jumping to anchor again
    setTimeout(function() {
        var anchor = location.hash;
        // need to jump to different anchor first (e.g. none)
        location.hash = "#";
        setTimeout(function() {
            location.hash = anchor;
        }, 0);
    }, 0);
  </script>
</head>
<body>
<div class="header" id="qtdocheader">
    <div class="main">
    <div class="main-rounded">
        <div class="navigationbar">
        <ul>
<li><a href="../qtdoc/index.html" translate="no">Qt 6.6</a></li>
<li><a href="qthttpserver-index.html" translate="no">Qt HTTP Server</a></li>
<li><a href="qthttpserver-examples.html" translate="no">Qt HTTP Server Examples</a></li>
<li>RESTful Color Palette Server</li>
<li id="buildversion"><a href="qthttpserver-index.html" translate="no">Qt 6.6&#x2e;0 Reference Documentation</a></li>
    </ul>
    </div>
</div>
<div class="content">
<div class="line">
<div class="content mainContent">
<h1 class="title">RESTful Color Palette Server</h1>
<pre class="cpp" translate="no">
 <span class="comment">// Copyright (C) 2022 The Qt Company Ltd.</span>
 <span class="comment">// SPDX-License-Identifier: LicenseRef-Qt-Commercial OR BSD-3-Clause</span>

 <span class="preprocessor">#include &quot;apibehavior.h&quot;</span>
 <span class="preprocessor">#include &quot;types.h&quot;</span>
 <span class="preprocessor">#include &quot;utils.h&quot;</span>
 <span class="preprocessor">#include &lt;QtCore/QCoreApplication&gt;</span>
 <span class="preprocessor">#include &lt;QtHttpServer/QHttpServer&gt;</span>

 <span class="preprocessor">#define SCHEME &quot;http&quot;</span>
 <span class="preprocessor">#define HOST &quot;127.0.0.1&quot;</span>
 <span class="preprocessor">#define PORT 49425</span>

 <span class="keyword">template</span><span class="operator">&lt;</span><span class="keyword">typename</span> T<span class="operator">&gt;</span>
 <span class="type">void</span> addCrudRoutes(<span class="type"><a href="qhttpserver.html" translate="no">QHttpServer</a></span> <span class="operator">&amp;</span>httpServer<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span> <span class="operator">&amp;</span>apiPath<span class="operator">,</span> CrudApi<span class="operator">&lt;</span>T<span class="operator">&gt;</span> <span class="operator">&amp;</span>api<span class="operator">,</span>
                    <span class="keyword">const</span> SessionApi <span class="operator">&amp;</span>sessionApi)
 {
     httpServer<span class="operator">.</span>route(
             <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span>(<span class="string">&quot;%1&quot;</span>)<span class="operator">.</span>arg(apiPath)<span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Get<span class="operator">,</span>
             <span class="operator">[</span><span class="operator">&amp;</span>api<span class="operator">]</span>(<span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>request) { <span class="keyword">return</span> api<span class="operator">.</span>getPaginatedList(request); });

     httpServer<span class="operator">.</span>route(<span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span>(<span class="string">&quot;%1/&lt;arg&gt;&quot;</span>)<span class="operator">.</span>arg(apiPath)<span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Get<span class="operator">,</span>
                      <span class="operator">[</span><span class="operator">&amp;</span>api<span class="operator">]</span>(<span class="type"><a href="../qtcore/qttypes.html#qint64-typedef" translate="no">qint64</a></span> itemId) { <span class="keyword">return</span> api<span class="operator">.</span>getItem(itemId); });

     httpServer<span class="operator">.</span>route(<span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span>(<span class="string">&quot;%1&quot;</span>)<span class="operator">.</span>arg(apiPath)<span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Post<span class="operator">,</span>
                      <span class="operator">[</span><span class="operator">&amp;</span>api<span class="operator">,</span> <span class="operator">&amp;</span>sessionApi<span class="operator">]</span>(<span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>request) {
                          <span class="keyword">if</span> (<span class="operator">!</span>sessionApi<span class="operator">.</span>authorize(request)) {
                              <span class="keyword">return</span> <span class="type"><a href="qhttpserverresponse.html" translate="no">QHttpServerResponse</a></span>(
                                      <span class="type"><a href="qhttpserverresponder.html" translate="no">QHttpServerResponder</a></span><span class="operator">::</span>StatusCode<span class="operator">::</span>Unauthorized);
                          }
                          <span class="keyword">return</span> api<span class="operator">.</span>postItem(request);
                      });

     httpServer<span class="operator">.</span>route(<span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span>(<span class="string">&quot;%1/&lt;arg&gt;&quot;</span>)<span class="operator">.</span>arg(apiPath)<span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Put<span class="operator">,</span>
                      <span class="operator">[</span><span class="operator">&amp;</span>api<span class="operator">,</span> <span class="operator">&amp;</span>sessionApi<span class="operator">]</span>(<span class="type"><a href="../qtcore/qttypes.html#qint64-typedef" translate="no">qint64</a></span> itemId<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>request) {
                          <span class="keyword">if</span> (<span class="operator">!</span>sessionApi<span class="operator">.</span>authorize(request)) {
                              <span class="keyword">return</span> <span class="type"><a href="qhttpserverresponse.html" translate="no">QHttpServerResponse</a></span>(
                                      <span class="type"><a href="qhttpserverresponder.html" translate="no">QHttpServerResponder</a></span><span class="operator">::</span>StatusCode<span class="operator">::</span>Unauthorized);
                          }
                          <span class="keyword">return</span> api<span class="operator">.</span>updateItem(itemId<span class="operator">,</span> request);
                      });

     httpServer<span class="operator">.</span>route(<span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span>(<span class="string">&quot;%1/&lt;arg&gt;&quot;</span>)<span class="operator">.</span>arg(apiPath)<span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Patch<span class="operator">,</span>
                      <span class="operator">[</span><span class="operator">&amp;</span>api<span class="operator">,</span> <span class="operator">&amp;</span>sessionApi<span class="operator">]</span>(<span class="type"><a href="../qtcore/qttypes.html#qint64-typedef" translate="no">qint64</a></span> itemId<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>request) {
                          <span class="keyword">if</span> (<span class="operator">!</span>sessionApi<span class="operator">.</span>authorize(request)) {
                              <span class="keyword">return</span> <span class="type"><a href="qhttpserverresponse.html" translate="no">QHttpServerResponse</a></span>(
                                      <span class="type"><a href="qhttpserverresponder.html" translate="no">QHttpServerResponder</a></span><span class="operator">::</span>StatusCode<span class="operator">::</span>Unauthorized);
                          }
                          <span class="keyword">return</span> api<span class="operator">.</span>updateItemFields(itemId<span class="operator">,</span> request);
                      });

     httpServer<span class="operator">.</span>route(<span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span>(<span class="string">&quot;%1/&lt;arg&gt;&quot;</span>)<span class="operator">.</span>arg(apiPath)<span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Delete<span class="operator">,</span>
                      <span class="operator">[</span><span class="operator">&amp;</span>api<span class="operator">,</span> <span class="operator">&amp;</span>sessionApi<span class="operator">]</span>(<span class="type"><a href="../qtcore/qttypes.html#qint64-typedef" translate="no">qint64</a></span> itemId<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>request) {
                          <span class="keyword">if</span> (<span class="operator">!</span>sessionApi<span class="operator">.</span>authorize(request)) {
                              <span class="keyword">return</span> <span class="type"><a href="qhttpserverresponse.html" translate="no">QHttpServerResponse</a></span>(
                                      <span class="type"><a href="qhttpserverresponder.html" translate="no">QHttpServerResponder</a></span><span class="operator">::</span>StatusCode<span class="operator">::</span>Unauthorized);
                          }
                          <span class="keyword">return</span> api<span class="operator">.</span>deleteItem(itemId);
                      });
 }

 <span class="type">int</span> main(<span class="type">int</span> argc<span class="operator">,</span> <span class="type">char</span> <span class="operator">*</span>argv<span class="operator">[</span><span class="operator">]</span>)
 {
     <span class="type"><a href="../qtcore/qcoreapplication.html" translate="no">QCoreApplication</a></span> app(argc<span class="operator">,</span> argv);

     <span class="type"><a href="../qtcore/qcommandlineparser.html" translate="no">QCommandLineParser</a></span> parser;
     parser<span class="operator">.</span>addOptions({
             { <span class="string">&quot;port&quot;</span><span class="operator">,</span> <span class="type"><a href="../qtcore/qcoreapplication.html" translate="no">QCoreApplication</a></span><span class="operator">::</span>translate(<span class="string">&quot;main&quot;</span><span class="operator">,</span> <span class="string">&quot;The port the server listens on.&quot;</span>)<span class="operator">,</span>
               <span class="string">&quot;port&quot;</span> }<span class="operator">,</span>
     });
     parser<span class="operator">.</span>addHelpOption();
     parser<span class="operator">.</span>process(app);

     <span class="type"><a href="../qtcore/qttypes.html#quint16-typedef" translate="no">quint16</a></span> portArg <span class="operator">=</span> PORT;
     <span class="keyword">if</span> (<span class="operator">!</span>parser<span class="operator">.</span>value(<span class="string">&quot;port&quot;</span>)<span class="operator">.</span>isEmpty())
         portArg <span class="operator">=</span> parser<span class="operator">.</span>value(<span class="string">&quot;port&quot;</span>)<span class="operator">.</span>toUShort();

     <span class="keyword">auto</span> colorFactory <span class="operator">=</span> std<span class="operator">::</span>make_unique<span class="operator">&lt;</span>ColorFactory<span class="operator">&gt;</span>();
     <span class="keyword">auto</span> colors <span class="operator">=</span> tryLoadFromFile<span class="operator">&lt;</span>Color<span class="operator">&gt;</span>(<span class="operator">*</span>colorFactory<span class="operator">,</span> <span class="string">&quot;:/assets/colors.json&quot;</span>);
     CrudApi<span class="operator">&lt;</span>Color<span class="operator">&gt;</span> colorsApi(std<span class="operator">::</span>move(colors)<span class="operator">,</span> std<span class="operator">::</span>move(colorFactory));

     <span class="keyword">auto</span> userFactory <span class="operator">=</span> std<span class="operator">::</span>make_unique<span class="operator">&lt;</span>UserFactory<span class="operator">&gt;</span>(SCHEME<span class="operator">,</span> HOST<span class="operator">,</span> portArg);
     <span class="keyword">auto</span> users <span class="operator">=</span> tryLoadFromFile<span class="operator">&lt;</span>User<span class="operator">&gt;</span>(<span class="operator">*</span>userFactory<span class="operator">,</span> <span class="string">&quot;:/assets/users.json&quot;</span>);
     CrudApi<span class="operator">&lt;</span>User<span class="operator">&gt;</span> usersApi(std<span class="operator">::</span>move(users)<span class="operator">,</span> std<span class="operator">::</span>move(userFactory));

     <span class="keyword">auto</span> sessionEntryFactory <span class="operator">=</span> std<span class="operator">::</span>make_unique<span class="operator">&lt;</span>SessionEntryFactory<span class="operator">&gt;</span>();
     <span class="keyword">auto</span> sessions <span class="operator">=</span> tryLoadFromFile<span class="operator">&lt;</span>SessionEntry<span class="operator">&gt;</span>(<span class="operator">*</span>sessionEntryFactory<span class="operator">,</span> <span class="string">&quot;:/assets/sessions.json&quot;</span>);
     SessionApi sessionApi(std<span class="operator">::</span>move(sessions)<span class="operator">,</span> std<span class="operator">::</span>move(sessionEntryFactory));

     <span class="comment">// Setup QHttpServer</span>
     <span class="type"><a href="qhttpserver.html" translate="no">QHttpServer</a></span> httpServer;
     httpServer<span class="operator">.</span>route(<span class="string">&quot;/&quot;</span><span class="operator">,</span> <span class="operator">[</span><span class="operator">]</span>() {
         <span class="keyword">return</span> <span class="string">&quot;Qt Colorpalette example server. Please see documentation for API description&quot;</span>;
     });

     addCrudRoutes(httpServer<span class="operator">,</span> <span class="string">&quot;/api/unknown&quot;</span><span class="operator">,</span> colorsApi<span class="operator">,</span> sessionApi);
     addCrudRoutes(httpServer<span class="operator">,</span> <span class="string">&quot;/api/users&quot;</span><span class="operator">,</span> usersApi<span class="operator">,</span> sessionApi);

     <span class="comment">// Login resource</span>
     httpServer<span class="operator">.</span>route(
             <span class="string">&quot;/api/login&quot;</span><span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Post<span class="operator">,</span>
             <span class="operator">[</span><span class="operator">&amp;</span>sessionApi<span class="operator">]</span>(<span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>request) { <span class="keyword">return</span> sessionApi<span class="operator">.</span>login(request); });

     httpServer<span class="operator">.</span>route(<span class="string">&quot;/api/register&quot;</span><span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Post<span class="operator">,</span>
                      <span class="operator">[</span><span class="operator">&amp;</span>sessionApi<span class="operator">]</span>(<span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>request) {
                          <span class="keyword">return</span> sessionApi<span class="operator">.</span>registerSession(request);
                      });

     httpServer<span class="operator">.</span>route(<span class="string">&quot;/api/logout&quot;</span><span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Post<span class="operator">,</span>
                      <span class="operator">[</span><span class="operator">&amp;</span>sessionApi<span class="operator">]</span>(<span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>request) {
                          <span class="keyword">return</span> sessionApi<span class="operator">.</span>logout(request);
                      });

     <span class="comment">// Images resource</span>
     httpServer<span class="operator">.</span>route(<span class="string">&quot;/img/faces/&lt;arg&gt;-image.jpg&quot;</span><span class="operator">,</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span><span class="operator">::</span>Method<span class="operator">::</span>Get<span class="operator">,</span>
                      <span class="operator">[</span><span class="operator">]</span>(<span class="type"><a href="../qtcore/qttypes.html#qint64-typedef" translate="no">qint64</a></span> imageId<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="qhttpserverrequest.html" translate="no">QHttpServerRequest</a></span> <span class="operator">&amp;</span>) {
                          <span class="keyword">return</span> <span class="type"><a href="qhttpserverresponse.html" translate="no">QHttpServerResponse</a></span><span class="operator">::</span>fromFile(
                                  <span class="type"><a href="../qtcore/qstring.html" translate="no">QString</a></span>(<span class="string">&quot;:/assets/img/%1-image.jpg&quot;</span>)<span class="operator">.</span>arg(imageId));
                      });

     <span class="keyword">const</span> <span class="keyword">auto</span> port <span class="operator">=</span> httpServer<span class="operator">.</span>listen(<span class="type"><a href="../qtnetwork/qhostaddress.html" translate="no">QHostAddress</a></span><span class="operator">::</span>Any<span class="operator">,</span> portArg);
     <span class="keyword">if</span> (<span class="operator">!</span>port) {
         <a href="../qtcore/qtlogging.html#qDebug" translate="no">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qcoreapplication.html" translate="no">QCoreApplication</a></span><span class="operator">::</span>translate(<span class="string">&quot;QHttpServerExample&quot;</span><span class="operator">,</span>
                                                 <span class="string">&quot;Server failed to listen on a port.&quot;</span>);
         <span class="keyword">return</span> <span class="number">0</span>;
     }

     <a href="../qtcore/qtlogging.html#qDebug" translate="no">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qcoreapplication.html" translate="no">QCoreApplication</a></span><span class="operator">::</span>translate(
                         <span class="string">&quot;QHttpServerExample&quot;</span><span class="operator">,</span>
                         <span class="string">&quot;Running on http://127.0.0.1:%1/ (Press CTRL+C to quit)&quot;</span>)
                         <span class="operator">.</span>arg(port);

     <span class="keyword">return</span> app<span class="operator">.</span>exec();
 }
</pre>
