name: build

on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  # Allows for the workflow to be manually started through the GitHub UI
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      QT6_VERSION: '6.6.0'
    steps:
      - name: Check Contexts and Secrets
        run: |
          echo "[Contexts]"
          echo "github.job = ${{ github.job }}"
          echo "github.ref = ${{ github.ref }}"
          echo "github.ref_name = ${{ github.ref_name }}"
          echo "github.event_name = ${{ github.event_name }}"
          echo "[Secrets]"
          echo "secrets.GITHUB_TOKEN = ${{ secrets.GITHUB_TOKEN }}"

      - name: Checkout to '${{ github.ref }}'
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      # https://wiki.qt.io/Building_Qt_6_from_Git
      - name: Install the Prerequisites
        run: |
          sudo apt update
          sudo apt install \
            cmake \
            python3 \
            python3-pip \
            ninja-build \
            bison \
            flex \
            perl \
            gperf \
            libclang-dev \
            libgl-dev \
            libegl-dev \
            libfontconfig1-dev \
            libinput-dev
          sudo snap install node --classic
          pip install html5lib

      - name: Check the Installation
        run: |
          cmake --version
          python3 --version
          ninja --version
          # nodejs --version
          node --version
          bison --version
          flex --version
          perl --version
          gperf --version

      - name: Prepare Qt6 Sources
        run: |
          curl -L https://download.qt.io/archive/qt/6.6/${{ env.QT6_VERSION }}/single/qt-everywhere-src-${{ env.QT6_VERSION }}.tar.xz -o qt-everywhere-src-${{ env.QT6_VERSION }}.tar.xz
          tar -xf qt-everywhere-src-${{ env.QT6_VERSION }}.tar.xz
          mv qt-everywhere-src-${{ env.QT6_VERSION }} qt6

      - name: Configure Qt6 Documentation
        run: |
          cd qt6
          mkdir build-qt && cd build-qt
          ../configure \
            -developer-build \
            -no-feature-qtwebengine-build

      - name: Build Qt6 Documentation
        run: |
          cd qt6
          cd build-qt
          cmake --build . --target html_docs

      # - name: Deploy to 'gh-pages' branch
      #   uses: JamesIves/github-pages-deploy-action@v4
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     branch: gh-pages
      #     folder: ./linux/Documentation/output
      #     target-folder: .
      #     clean: false