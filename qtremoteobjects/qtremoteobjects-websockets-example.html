<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<!-- websocket.qdoc -->
  <meta name="description" content="Using a non-QIODevice-based transport (QWebSocket) with QtRemoteObjects.">
  <title>QtRemoteObjects WebSockets Applications | Qt Remote Objects 6.6.2</title>
  <link rel="stylesheet" type="text/css" href="style/offline-simple.css" />
  <script type="text/javascript">
    document.getElementsByTagName("link").item(0).setAttribute("href", "style/offline.css");
    // loading style sheet breaks anchors that were jumped to before
    // so force jumping to anchor again
    setTimeout(function() {
        var anchor = location.hash;
        // need to jump to different anchor first (e.g. none)
        location.hash = "#";
        setTimeout(function() {
            location.hash = anchor;
        }, 0);
    }, 0);
  </script>
</head>
<body>
<div class="header" id="qtdocheader">
    <div class="main">
    <div class="main-rounded">
        <div class="navigationbar">
        <ul>
<li><a href="../qtdoc/index.html" translate="no">Qt 6.6</a></li>
<li><a href="qtremoteobjects-index.html" translate="no">Qt Remote Objects</a></li>
<li><a href="qtremoteobjects-examples.html" translate="no">Qt Remote Objects Examples</a></li>
<li>QtRemoteObjects WebSockets Applications</li>
<li id="buildversion"><a href="qtremoteobjects-index.html" translate="no">Qt 6.6.2 Reference Documentation</a></li>
    </ul>
    </div>
</div>
<div class="content">
<div class="line">
<div class="content mainContent">
<div class="sidebar">
<div class="toc">
<h3 id="toc">Contents</h3>
<ul>
<li class="level1"><a href="#the-wsserver-application">The WsServer Application</a></li>
<li class="level1"><a href="#the-wsclient-application">The WsClient Application</a></li>
</ul>
</div>
<div class="sidebar-content" id="sidebar-content"></div></div>
<h1 class="title">QtRemoteObjects WebSockets Applications</h1>
<!-- $$$websockets-brief -->
<p>Using a non-<a href="../qtcore/qiodevice.html" translate="no">QIODevice</a>-based transport (QWebSocket) with <a href="qml-qtremoteobjects-qtremoteobjects.html" translate="no">QtRemoteObjects</a>.</p>
<!-- @@@websockets -->
<!-- $$$websockets-description -->
<div class="descr" id="details">
<p>This example shares a <code translate="no">QStandardItemModel</code> over a web socket. The model can be edited in the window of the <code translate="no">wsserver</code> application, and the changes are propagated to the window of the <code translate="no">wsclient</code> application.</p>
<p>This is made possible by implementing a small <a href="../qtcore/qiodevice.html" translate="no">QIODevice</a>-derived wrapper, <code translate="no">WebSocketIoDevice</code>, for <code translate="no">QWebSocket</code>. SSL is used if Qt is compiled with support for it.</p>
<p class="centerAlign"><img src="images/StandardItemTableWindow.webp" alt="" /></p><h4 id="the-wsserver-application">The WsServer Application</h4>
<p>The <code translate="no">wsserver</code> application creates a <code translate="no">QStandardItemModel</code> with two columns and inserts data into it.</p>
<pre class="cpp" translate="no">
 <span class="type">int</span> main(<span class="type">int</span> argc<span class="operator">,</span> <span class="type">char</span> <span class="operator">*</span>argv<span class="operator">[</span><span class="operator">]</span>)
 {
     <span class="type"><a href="../qtcore/qloggingcategory.html" translate="no">QLoggingCategory</a></span><span class="operator">::</span>setFilterRules(<span class="string">&quot;qt.remoteobjects.debug=false\n&quot;</span>
                                      <span class="string">&quot;qt.remoteobjects.warning=false&quot;</span>);
     <span class="type">QApplication</span> app(argc<span class="operator">,</span> argv);

     <span class="keyword">const</span> <span class="type">int</span> modelSize <span class="operator">=</span> <span class="number">100000</span>;
     <span class="type"><a href="../qtcore/qstringlist.html" translate="no">QStringList</a></span> list;
     <span class="type">QStandardItemModel</span> sourceModel;
     <span class="type"><a href="../qtcore/qstringlist.html" translate="no">QStringList</a></span> hHeaderList;
     hHeaderList <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;First Column with spacing&quot;</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;Second Column with spacing&quot;</span>);
     sourceModel<span class="operator">.</span>setHorizontalHeaderLabels(hHeaderList);
     list<span class="operator">.</span>reserve(modelSize);
     <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> modelSize; <span class="operator">+</span><span class="operator">+</span>i) {
         <span class="type">QStandardItem</span> <span class="operator">*</span>firstItem <span class="operator">=</span> <span class="keyword">new</span> <span class="type">QStandardItem</span>(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;FancyTextNumber %1&quot;</span>)<span class="operator">.</span>arg(i));
         <span class="keyword">if</span> (i <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>)
             firstItem<span class="operator">-</span><span class="operator">&gt;</span>appendRow(addChild(<span class="number">2</span><span class="operator">,</span> <span class="number">2</span>));
         <span class="type">QStandardItem</span> <span class="operator">*</span>secondItem <span class="operator">=</span> <span class="keyword">new</span> <span class="type">QStandardItem</span>(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;FancyRow2TextNumber %1&quot;</span>)<span class="operator">.</span>arg(i));
         <span class="keyword">if</span> (i <span class="operator">%</span> <span class="number">2</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>)
             firstItem<span class="operator">-</span><span class="operator">&gt;</span>setBackground(<span class="type"><a href="../qtcore/qt.html" translate="no">Qt</a></span><span class="operator">::</span>red);
         <span class="type"><a href="../qtcore/qlist.html" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type">QStandardItem</span><span class="operator">*</span><span class="operator">&gt;</span> row;
         row <span class="operator">&lt;</span><span class="operator">&lt;</span> firstItem <span class="operator">&lt;</span><span class="operator">&lt;</span> secondItem;
         sourceModel<span class="operator">.</span>invisibleRootItem()<span class="operator">-</span><span class="operator">&gt;</span>appendRow(row);
         <span class="comment">//sourceModel.appendRow(row);</span>
         list <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;FancyTextNumber %1&quot;</span>)<span class="operator">.</span>arg(i);
     }
</pre>
<p>It then starts a <code translate="no">QWebSocketServer</code> bound to port 8088, and hosts the data model.</p>
<pre class="cpp" translate="no">
 <span class="type">QWebSocketServer</span> webSockServer{<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;WS QtRO&quot;</span>)<span class="operator">,</span> <span class="type">QWebSocketServer</span><span class="operator">::</span>NonSecureMode};
 webSockServer<span class="operator">.</span>listen(<span class="type"><a href="../qtnetwork/qhostaddress.html" translate="no">QHostAddress</a></span><span class="operator">::</span>Any<span class="operator">,</span> <span class="number">8088</span>);

 <span class="type"><a href="qremoteobjecthost.html" translate="no">QRemoteObjectHost</a></span> hostNode;
 hostNode<span class="operator">.</span>setHostUrl(webSockServer<span class="operator">.</span>serverAddress()<span class="operator">.</span>toString()<span class="operator">,</span> <span class="type"><a href="qremoteobjecthost.html" translate="no">QRemoteObjectHost</a></span><span class="operator">::</span>AllowExternalRegistration);

 hostNode<span class="operator">.</span>enableRemoting(<span class="operator">&amp;</span>sourceModel<span class="operator">,</span> <span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;RemoteModel&quot;</span>)<span class="operator">,</span> roles);
</pre>
<p>When handling new connections, SSL is configured if Qt is compiled with support for it. Then a <code translate="no">WebSocketIoDevice</code> is created using the incoming WebSocketServer connection.</p>
<pre class="cpp" translate="no">
 <span class="type"><a href="../qtcore/qobject.html" translate="no">QObject</a></span><span class="operator">::</span>connect(<span class="operator">&amp;</span>webSockServer<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QWebSocketServer</span><span class="operator">::</span>newConnection<span class="operator">,</span> <span class="operator">&amp;</span>hostNode<span class="operator">,</span> <span class="operator">[</span><span class="operator">&amp;</span>hostNode<span class="operator">,</span> <span class="operator">&amp;</span>webSockServer<span class="operator">]</span>{
     <span class="keyword">while</span> (<span class="keyword">auto</span> conn <span class="operator">=</span> webSockServer<span class="operator">.</span>nextPendingConnection()) {
 <span class="preprocessor">#ifndef QT_NO_SSL</span>
         <span class="comment">// Always use secure connections when available</span>
         <span class="type"><a href="../qtnetwork/qsslconfiguration.html" translate="no">QSslConfiguration</a></span> sslConf;
         <span class="type"><a href="../qtcore/qfile.html" translate="no">QFile</a></span> certFile(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;:/sslcert/server.crt&quot;</span>));
         <span class="keyword">if</span> (<span class="operator">!</span>certFile<span class="operator">.</span>open(<span class="type"><a href="../qtcore/qiodevice.html" translate="no">QIODevice</a></span><span class="operator">::</span>ReadOnly))
             <a href="../qtcore/qtlogging.html#qFatal" translate="no">qFatal</a>(<span class="string">&quot;Can't open client.crt file&quot;</span>);
         sslConf<span class="operator">.</span>setLocalCertificate(<span class="type"><a href="../qtnetwork/qsslcertificate.html" translate="no">QSslCertificate</a></span>{certFile<span class="operator">.</span>readAll()});

         <span class="type"><a href="../qtcore/qfile.html" translate="no">QFile</a></span> keyFile(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;:/sslcert/server.key&quot;</span>));
         <span class="keyword">if</span> (<span class="operator">!</span>keyFile<span class="operator">.</span>open(<span class="type"><a href="../qtcore/qiodevice.html" translate="no">QIODevice</a></span><span class="operator">::</span>ReadOnly))
             <a href="../qtcore/qtlogging.html#qFatal" translate="no">qFatal</a>(<span class="string">&quot;Can't open client.key file&quot;</span>);
         sslConf<span class="operator">.</span>setPrivateKey(<span class="type"><a href="../qtnetwork/qsslkey.html" translate="no">QSslKey</a></span>{keyFile<span class="operator">.</span>readAll()<span class="operator">,</span> <span class="type"><a href="../qtnetwork/qssl.html" translate="no">QSsl</a></span><span class="operator">::</span>Rsa});

         sslConf<span class="operator">.</span>setPeerVerifyMode(<span class="type"><a href="../qtnetwork/qsslsocket.html" translate="no">QSslSocket</a></span><span class="operator">::</span>VerifyPeer);
         conn<span class="operator">-</span><span class="operator">&gt;</span>setSslConfiguration(sslConf);
         <span class="type"><a href="../qtcore/qobject.html" translate="no">QObject</a></span><span class="operator">::</span>connect(conn<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QWebSocket</span><span class="operator">::</span>sslErrors<span class="operator">,</span> conn<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QWebSocket</span><span class="operator">::</span>deleteLater);
 <span class="preprocessor">#endif</span>
         <span class="type"><a href="../qtcore/qobject.html" translate="no">QObject</a></span><span class="operator">::</span>connect(conn<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QWebSocket</span><span class="operator">::</span>disconnected<span class="operator">,</span> conn<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QWebSocket</span><span class="operator">::</span>deleteLater);
         <span class="type"><a href="../qtcore/qobject.html" translate="no">QObject</a></span><span class="operator">::</span>connect(conn<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QWebSocket</span><span class="operator">::</span>errorOccurred<span class="operator">,</span> conn<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QWebSocket</span><span class="operator">::</span>deleteLater);
         <span class="keyword">auto</span> ioDevice <span class="operator">=</span> <span class="keyword">new</span> WebSocketIoDevice(conn);
         <span class="type"><a href="../qtcore/qobject.html" translate="no">QObject</a></span><span class="operator">::</span>connect(conn<span class="operator">,</span> <span class="operator">&amp;</span><span class="type">QWebSocket</span><span class="operator">::</span>destroyed<span class="operator">,</span> ioDevice<span class="operator">,</span> <span class="operator">&amp;</span>WebSocketIoDevice<span class="operator">::</span>deleteLater);
         hostNode<span class="operator">.</span>addHostSideConnection(ioDevice);
     }
 });
</pre>
<p>A QTreeView is created with the QStandardItemModel as model. Then multiple timers are started with <a href="../qtcore/qtimer.html#singleShot" translate="no">QTimer::singleShot</a> to perform more modifications to the model.</p>
<pre class="cpp" translate="no">
 <span class="type">QTreeView</span> view;
 view<span class="operator">.</span>setWindowTitle(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;SourceView&quot;</span>));
 view<span class="operator">.</span>setModel(<span class="operator">&amp;</span>sourceModel);
 view<span class="operator">.</span>show();
 TimerHandler handler;
 handler<span class="operator">.</span>model <span class="operator">=</span> <span class="operator">&amp;</span>sourceModel;
 <span class="type"><a href="../qtcore/qtimer.html" translate="no">QTimer</a></span><span class="operator">::</span>singleShot(<span class="number">5000</span><span class="operator">,</span> <span class="operator">&amp;</span>handler<span class="operator">,</span> <span class="operator">&amp;</span>TimerHandler<span class="operator">::</span>changeData);
 <span class="type"><a href="../qtcore/qtimer.html" translate="no">QTimer</a></span><span class="operator">::</span>singleShot(<span class="number">10000</span><span class="operator">,</span> <span class="operator">&amp;</span>handler<span class="operator">,</span> <span class="operator">&amp;</span>TimerHandler<span class="operator">::</span>insertData);
 <span class="type"><a href="../qtcore/qtimer.html" translate="no">QTimer</a></span><span class="operator">::</span>singleShot(<span class="number">11000</span><span class="operator">,</span> <span class="operator">&amp;</span>handler<span class="operator">,</span> <span class="operator">&amp;</span>TimerHandler<span class="operator">::</span>changeFlags);
 <span class="type"><a href="../qtcore/qtimer.html" translate="no">QTimer</a></span><span class="operator">::</span>singleShot(<span class="number">12000</span><span class="operator">,</span> <span class="operator">&amp;</span>handler<span class="operator">,</span> <span class="operator">&amp;</span>TimerHandler<span class="operator">::</span>removeData);
 <span class="type"><a href="../qtcore/qtimer.html" translate="no">QTimer</a></span><span class="operator">::</span>singleShot(<span class="number">13000</span><span class="operator">,</span> <span class="operator">&amp;</span>handler<span class="operator">,</span> <span class="operator">&amp;</span>TimerHandler<span class="operator">::</span>moveData);

 <span class="keyword">return</span> app<span class="operator">.</span>exec();
</pre>
<h4 id="the-wsclient-application">The WsClient Application</h4>
<p>The <code translate="no">wsclient</code> application creates a QWebSocket and a <code translate="no">WebSocketIoDevice</code> taking it as an argument.</p>
<pre class="cpp" translate="no">
 <span class="type"><a href="../qtcore/qscopedpointer.html" translate="no">QScopedPointer</a></span><span class="operator">&lt;</span><span class="type">QWebSocket</span><span class="operator">&gt;</span> webSocket{<span class="keyword">new</span> <span class="type">QWebSocket</span>};
 WebSocketIoDevice socket(webSocket<span class="operator">.</span>data());
</pre>
<p>If Qt is compiled with support for SSL, the client is configured with it.</p>
<pre class="cpp" translate="no">
 <span class="preprocessor">#ifndef QT_NO_SSL</span>
     <span class="comment">// Always use secure connections when available</span>
     <span class="type"><a href="../qtnetwork/qsslconfiguration.html" translate="no">QSslConfiguration</a></span> sslConf;
     <span class="type"><a href="../qtcore/qfile.html" translate="no">QFile</a></span> certFile(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;:/sslcert/client.crt&quot;</span>));
     <span class="keyword">if</span> (<span class="operator">!</span>certFile<span class="operator">.</span>open(<span class="type"><a href="../qtcore/qiodevice.html" translate="no">QIODevice</a></span><span class="operator">::</span>ReadOnly))
         <a href="../qtcore/qtlogging.html#qFatal" translate="no">qFatal</a>(<span class="string">&quot;Can't open client.crt file&quot;</span>);
     sslConf<span class="operator">.</span>setLocalCertificate(<span class="type"><a href="../qtnetwork/qsslcertificate.html" translate="no">QSslCertificate</a></span>{certFile<span class="operator">.</span>readAll()});

     <span class="type"><a href="../qtcore/qfile.html" translate="no">QFile</a></span> keyFile(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;:/sslcert/client.key&quot;</span>));
     <span class="keyword">if</span> (<span class="operator">!</span>keyFile<span class="operator">.</span>open(<span class="type"><a href="../qtcore/qiodevice.html" translate="no">QIODevice</a></span><span class="operator">::</span>ReadOnly))
         <a href="../qtcore/qtlogging.html#qFatal" translate="no">qFatal</a>(<span class="string">&quot;Can't open client.key file&quot;</span>);
     sslConf<span class="operator">.</span>setPrivateKey(<span class="type"><a href="../qtnetwork/qsslkey.html" translate="no">QSslKey</a></span>{keyFile<span class="operator">.</span>readAll()<span class="operator">,</span> <span class="type"><a href="../qtnetwork/qssl.html" translate="no">QSsl</a></span><span class="operator">::</span>Rsa});

     sslConf<span class="operator">.</span>setPeerVerifyMode(<span class="type"><a href="../qtnetwork/qsslsocket.html" translate="no">QSslSocket</a></span><span class="operator">::</span>VerifyPeer);
     webSocket<span class="operator">-</span><span class="operator">&gt;</span>setSslConfiguration(sslConf);
 <span class="preprocessor">#endif</span>
</pre>
<p>Then a <a href="qremoteobjectnode.html" translate="no">QRemoteObjectNode</a> is created, and setup to use the WebSocketIoDevice. Then it connects to <code translate="no">wsserver</code>.</p>
<pre class="cpp" translate="no">
 <span class="type"><a href="qremoteobjectnode.html" translate="no">QRemoteObjectNode</a></span> node;
 node<span class="operator">.</span>addClientSideConnection(<span class="operator">&amp;</span>socket);
 node<span class="operator">.</span>setHeartbeatInterval(<span class="number">1000</span>);
 webSocket<span class="operator">-</span><span class="operator">&gt;</span>open(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;ws://localhost:8088&quot;</span>));
</pre>
<p>A QTreeView is created to display the data from the server. The model is acquired from the node, and it is then set as the model of the QTreeView, which is then shown.</p>
<pre class="cpp" translate="no">
 <span class="type">QTreeView</span> view;
 view<span class="operator">.</span>setWindowTitle(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;RemoteView&quot;</span>));
 view<span class="operator">.</span>resize(<span class="number">640</span><span class="operator">,</span><span class="number">480</span>);
 <span class="type"><a href="../qtcore/qscopedpointer.html" translate="no">QScopedPointer</a></span><span class="operator">&lt;</span><span class="type"><a href="qabstractitemmodelreplica.html" translate="no">QAbstractItemModelReplica</a></span><span class="operator">&gt;</span> model(node<span class="operator">.</span>acquireModel(<span class="type"><a href="../qtcore/qstring.html#QStringLiteral" translate="no">QStringLiteral</a></span>(<span class="string">&quot;RemoteModel&quot;</span>)));
 view<span class="operator">.</span>setModel(model<span class="operator">.</span>data());
 view<span class="operator">.</span>show();

 <span class="keyword">return</span> app<span class="operator">.</span>exec();
</pre>
<p><a href="https://code.qt.io/cgit/qt/qtremoteobjects.git/tree/examples/remoteobjects/websockets?h=6.6" translate="no">Example project @ code.qt.io</a></p>
</div>
<!-- @@@websockets -->
        </div>
       </div>
   </div>
   </div>
</div>
<div class="footer">
   <p>
   <acronym title="Copyright">&copy;</acronym> 2024 <span translate="no">The Qt Company Ltd.</span>
   Documentation contributions included herein are the copyrights of
   their respective owners.<br/>    The documentation provided herein is licensed under the terms of the    <a href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation    License version 1.3</a> as published by the <span translate="no">Free Software Foundation</span>.<br/>    <span translate="no">Qt</span> and respective logos are <a href="https://doc.qt.io/qt/trademarks.html">    trademarks</a> of <span translate="no">The Qt Company Ltd.</span> in Finland and/or other countries
   worldwide. All other trademarks are property of their respective owners. </p>
</div>
</body>
</html>
